#!/bin/sh

TRK_INFO=1
APPLY_DEADMAP=1
MODE=1

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/gpfs/mnt/gpfs02/phenix/plhf/plhf3/nnovitzk/mazsi_Test/ccnt/source/emc-evaluation/build/.libs/:/phenix/u/vdoomra/install
export INSTALL=/phenix/u/vdoomra/install
export LD_LIBRARY_PATH=$INSTALL/lib:$LD_LIBRARY_PATH
export TSEARCHPATH=/phenix/u/vdoomra/install
export DCACHE_DOOR=phnxcore03.rcf.bnl.gov:1094
export GSEARCHPATH ${GSEARCHPATH}:DCACHE

echo $LD_LIBRARY_PATH
chmod g+rx ${_CONDOR_SCRATCH_DIR}
cd ${_CONDOR_SCRATCH_DIR}

RUNNUMBERS=(428737 428728 428892 427883 428323 428451 427968 422050 430905 430136 422040 428758 428733 422041 430522 431137 429022 428730 427129 428211 428255 427709 428318 431844 428261 431836 431125 427979 430693 431609 430494 429680 430927 430608 422043 430384 430121 431437 431608 430907 430239 428260 427362 427657 430563 428266 428264 430386 428454 428601 429365 428891 422066 430502 422123 428262 431146 430929 429127 431233 431362 429678 430594 429798 429129 427673 431886 427882 427233 427377 428615 427367 428324 430024 431951 427264 428267 428166 428171 430237 428771 428934 430128 429787 431122 428898 430141 428762 427658 429024 427144 426113 427366 427810 428168 427136 428754 428321 427881 429696 427975 429503 429888 430906 429886 430560 431028 430014 430701 430935 427982 431033 431143 431960 431448 431860 431894 427239 423546 431612 423311 431845 428326 430389 423041 429685 430914 430600 427397 427671 429133 422053 429595 421969 428772 430125 431839 427672 427111 430913 429505 424627 428603 429512 425168 423549 431139 428755 431123 422640 430234 430692 429067 428384 427887 426252 428268 430119 427502 427815 429887 431833 428734 430017 430932 431620 430120 428738 429026 431943 431149 430241 422531 422084 427498 430694 429795 431299 427674 429686 428382 430408 428447 429029 427806 431720 428763 429007 425583 431619 423109 428605 431259 422562 422319 427527 429890 431736 431224 429689 427670 430525 428710 428613 429906 429801 431942 429017 422045 422200 426443 430519 421815 431997 429025 430909 431840 429687 431134 427499 430921 427394 429556 429594 429027 424443 428930 430930 430933 429895 422074 427807 429023 430390 429016 424886 429010 428760 421988 422020 425290 428609 431020 430681 431302 430117 427829 430235 430598 430931 431240 430131 430924 430679 427510 427656 431832 428432 428265 431892 432001 430238 429014 422763 427708 431147 430700 429593 429679 429506 431745 430680 423576 431040 425688 424759 428610 428331 423820 428896 431023 430925 430409 431216 429893 428431 428207 429351 427977 431932 422051 430279 428893 430134 431622 431026 431357 431725 421975 429894 422540 427805 427383 427384 430520 430566 430133 425420 431429 427660 431940 428204 427481 427363 429789 431835 431453 431454 431963 421961 427712 431031 426308 430124 429905 430702 430023 425564 428739 431727 428616 422068 428607 430497 428618 422575 431889 427662 428453 427500 431219 429355 430501 430116 431361 431854 425172 427661 432007 431948 431893 430607 431136 431239 431221 431261 430500 431127 431834 431257 424439 430521 430123 429909 431030 429889 430142 431220 430242 430277 428715 428614 430407 430281 429555 431235 430414 421968 429797 424257 430013 428714 429796 430496 422611 422615 428381 429368 428273 423676 425212 424039 426117 430393 431260 431888 430236 428931 426282 430697 430415 431234 431145 428894 428717 429112 429504 430928 430565 430558 431831 430280 430699 424276 430923 429071 430596 426353 430936 430143 430682 431144 431138 431447 429554 426112 427654 430022 423275 429589 427530 428759 430920 424444 428929 430911 431846 430240 431432 431027 431301 431295 429364 429066 431615 431731 431142 431256 430912 431717 431618 430278 428713 426114 428206 427523 429069 428736 423132 427135 428757 431430 431217 431130 428735 431148 429126 427508 431746 429551 430406 431616 430676 430696 431360 431135 426409 425006 425294 421949 422055 422124 427361 428452 429128 427885 430524 431258 431358 429691 425395 428933 430402 422267 428319 427964 429592 431732 431298 428604 426461 429915 432008 431837 429912 427483 429590 430016 425377 421976 422064 426273 431738 430595 424053 429370 422148 431941 427811 431021 431294 430562 427019 427711 427482 429114 427605 429132 431739 431022 429549 430557 428386 427146 427514 427390 426313 424365 425553 426383 422201 427145 429552 423844 429800 428169 428617 431458 431938 427974 428329 427984 431733 424227 425293 424275 431131 431939 428269 427373 429361 426320 422057 428460 425434 422014 429591 427485 427360 427529 423432 429596 429115 428448 431428 422543 428433 427710 427262 430683 426316 431859 428608 429911 422054 431891 428328 429676 427713 431126 428446 428272 427027 425691 425173 429070 421816 428325 428379 427147 425566 429896 422067 427243 427484 429518 429799 429802 427241 428208 427389 427980 427385 424756 421989 422202 422263 427965 428455 427963 428602 425078 426319 429910 427021 427388 431744 427878 429068 422633 431937 427391 427149 427244 429688 428385 427486 428263 427398 428377 427141 428459 427970 427024 428212 427886 427137 422758 429062 427879 424368 422779 422614 424273 429352 426116 422075 422266 425214 428256 426115 422785 422268 423149 426283 430599 429353 425694 423101 429366 422756 424038 422255 427813 429519 423550 422323 424255 425433 426365 422141 422262 427148 423043 424052 424063 422782 421999 425215 424372 422147 422269 424585 422324 422085 422314 423301 427393 426307 424060 422135 427380 422322 425693 423845 422272 422613 427025 422205 422070 422273 422256 422018 422553 422203 427814 429359 423860 422762 424644 422566 424371 424040 426394 424827 422643 425016 422305 422260 424671 427013 423263 424880 426445 426406 424189 426408 424626 422298 423632 423548 424356 422618 424754 423703 426281 424760 425079 423685 425403 424881 423220 424557 426444 425428 426401 426397 425011 425008 425378 425409 424751 425286 426391 423278 423290 423110 423652 426442 425424 425692 423268 423424 423677 424051 423843 423696 424062 426378 425289 424441 425429 424190 424272 424353 425413 424761 425288 423856 423826 423865 424629 424836 425423 424885 423839 425295 423664 425431 425439 423553 424193 425397 426460 424195 423867 424763 424817 426450 425152 424452 424445 425080 423433 423679 424194 424755 427020 426407 425213 425422 425287 423547 426315 423828 424584 424877 424348 424440 423377 424061 425412 423579 424270 425171 425296 424358 425425 427026 423663 424055 426366 423868 425292)

RANDOM=$$
 
run_number=${RUNNUMBERS[ ($RANDOM) % ${#RUNNUMBERS[@]} ]}

echo "=====Generating a Random Run Number=========="

echo $run_number

echo "==============================================="
echo "============= START SIMULATION  ==============="
echo "==============================================="

INPUT=$(( $1 + $2 ))
echo $INPUT

DIR=`printf "%05d" $INPUT`
mkdir -p $DIR
pushd $DIR
echo start the simulation with PISA in directory $DIR

NEVT=10000

cp /phenix/plhf/vdoomra/simulation/PHENIXAcceptance.h .
cp /phenix/plhf/vdoomra/simulation/make_single_e_noAcceptance.C .

echo "=============================================="
echo "========Make Single Electrons================="
echo "=============================================="

root -l -b -q 'make_single_e_noAcceptance.C('$NEVT')'

mv oscar.txt oscar.particles.dat

echo "==============================================="
echo "============= START PISA NOW =================="
echo "==============================================="

mkdir pisa
pushd pisa

cp /phenix/plhf/vdoomra/simulation/pisa_svx/* .
mv ../oscar.particles.dat .

sed -i '4s/.*/ptrig '$NEVT'/' glogon.kumac

pisa<pisa.input

echo "==============================================="
echo "================ PISA TO DST =================="
echo "==============================================="

root -b -q -l 'pisaToDST_VTX.C('$NEVT', "PISAEvent.root", "dst_out.root", "svxeval.root", '$run_number', 0)'
cp /phenix/plhf/vdoomra/simulation/run_TTreeMaker.C .

root -l -b -q 'run_TTreeMaker.C("dst_out.root", "output.root", 0, 1)'

cp output.root /phenix/plhf/vdoomra/simulation/analysis_output_pions_noVTXReco/piminus_$run_number-$DIR.root

cp /phenix/plhf/vdoomra/vertex_reconstruction_C.so .
cp /phenix/plhf/vdoomra/field_map.root .
cp /phenix/plhf/vdoomra/dc_dead_map.h .

output_text=/phenix/plhf/vdoomra/VTXDeadMap/deadmap_files/out_$run_number.txt
echo $output_text

root -l -b <<EOF
    gSystem->Load("/phenix/u/vdoomra/install/lib/libDileptonAnalysisEvent"); 
    gSystem->Load("vertex_reconstruction_C.so");
    vertex_reconstruction("output.root","vtx_reco_out.root", "$output_text",$APPLY_DEADMAP,$TRK_INFO,$MODE)
EOF
mv vtx_reco_out.root /phenix/plhf/vdoomra/simulation/analysis_output_pions/piminus_$run_number-$DIR.root

popd
rm -rf pisa

popd
rm -r $DIR
